<!-- 
 * ReferenceEdge
 * 
 * Point of Reference, Inc. - Copyright 2014 All rights reserved.
 *
 * @company : Point of Reference, Inc.
 * @website : www.point-of-reference.com
 *
 * Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
 * WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
 * EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
 * AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
 * ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
 * WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
 * WRITTEN CONSENT FROM COMPANY. 
 -->
<apex:page id="pgId" standardController="refedge__Referenceability__c" extensions="refedge.AddNewReferenceabilityController" sidebar="false">
     <!-- Messages -->
    <apex:pageMessages id="pgmsgId"/>
    
    <!-- Add POR_ModalLoader Component-->
    <c:POR_ModalLoader id="PORLoader"/>
    <apex:stylesheet value="{!URLFOR($Resource.refedge__JqueryFiles, 'jquery-ui-1.9.2.custom.min.css')}"/>
    <!-- Form -->
    <apex:form id="frmId">
        <style>
            .pbSubheader
            {
                background-image : none !important;
            }
            jQuery(".ui-icon ui-icon-closethick").removeAttr();
            .ui-widget-content{
                border : none !important;
            }
            .ui-widget-header{
                background : none !important;
                border : none !important;
                color : black !important;
            } 
        </style>
        
        <apex:outputPanel id="msgPanel">
            <script>
				var referenceStatus=false;
				var ContactSelected;
				var referenceStatus =  {!isReferenceableStatus};
				function showPopup(isOnlySave){
					if(!referenceStatus && {!isContactSelected}){
						jQuery( "#dialogBoxDivCon" ).dialog({
							width: '400px',
							modal: true,
							resizable: false,
							draggable: false,
							buttons: {
								"{!$Label.Yes}" : function() {
									jQuery( this ).dialog( "close" );
									if(!{!isAccountReferenceableStatus}){
										jQuery( "#dialogBoxDivAcc" ).dialog({
											width: '400px',
											modal: true,
											resizable: false,
											draggable: false,
											buttons: {
												"{!$Label.Yes}" : function() {
													jQuery( this ).dialog( "close" );
													PORShowLoading();
													saveJs(true,isOnlySave);
												},
												"{!$Label.No}" : function() {
													jQuery( this ).dialog( "close" ); 
													PORShowLoading();
													saveJs(false,isOnlySave);
												}
											}
										});
										return false;
									}
									else {
										PORShowLoading();
										saveJs(true,isOnlySave);
									}
								},
								"{!$Label.No}" : function() {
									jQuery( this ).dialog( "close" ); 
								}
							}
						});
						jQuery(".ui-dialog-titlebar").hide();
						jQuery(".ui-dialog-content ui-widget-content").css("height", "auto");
						return false;
					}
					else {
						if(!{!isAccountReferenceableStatus}){
							jQuery( "#dialogBoxDivAcc" ).dialog({
								width: '400px',
								modal: true,
								resizable: false,
								draggable: false,
								buttons: {
									"{!$Label.Yes}" : function() {
										jQuery( this ).dialog( "close" );
										PORShowLoading();
										saveJs(true,isOnlySave);
									},
									"{!$Label.No}" : function() {
										jQuery( this ).dialog( "close" );
										
										if(!{!(isContactsRendered)}){
											PORShowLoading();
											saveJs(false,isOnlySave);
										}
										 
									}
								}
							});
							jQuery(".ui-dialog-titlebar").hide();
							jQuery(".ui-dialog-content ui-widget-content").css("height", "auto");
							return false;
						}
						else {
							PORShowLoading();
							saveJs(true,isOnlySave);
						}
						return false;
					}
					return false;
				}
				function redirectToPage(){
					PORHideLoading();
					if(!{!hasError}){
						redirectToPage1();
					}
				}
			</script>
        </apex:outputPanel>
        
        <apex:actionFunction name="findReferenceStatus" oncomplete="PORHideLoading();"  immediate="true" action="{!getReferenceStatus}" rerender="pgmsgId,butonPanel,msgPanel">
            <apex:param assignTo="{!selectedContact}" value="" name="paramName"/>
        </apex:actionFunction>
        <apex:actionFunction name="saveJs" oncomplete="redirectToPage();"  action="{!save}" reRender="pgmsgId,pbId,msgPanel">
            <apex:param assignTo="{!makeAccountMember}" value="" name="paramName"/>
            <apex:param assignTo="{!isOnlySave}" value="" name="paramName2"/>
        </apex:actionFunction>
        <apex:actionFunction name="deleteRef" immediate="true" action="{!deleteReferenceability}" rerender="pbId1" oncomplete="PORHideLoading();">
        	<apex:param assignTo="{!selectedReferenceability}" value="" name="selectedReferenceability"/>
        </apex:actionFunction>
        <apex:actionFunction name="redirectToPage1" action="{!redirectToPage}"/>
        <apex:sectionHeader title="{!$Label.Referencibility_Edit}" subtitle="{!$Label.New_Referenceability}"/>
        <apex:actionRegion >
        	<apex:outputPanel id="pbId1">
		      	<apex:pageBlock rendered="{!AND(OR(showReferenceabilityForContact,showReferenceabilityForAccount),referenceabilityPresent.size >0)}">
		      		<apex:pageBlockButtons >
		                <apex:outputPanel id="butonPanel">
		                    <apex:commandButton value="{!$Label.Done}" immediate="true" action="{!redirectToPage}"/>
		                </apex:outputPanel>
		            </apex:pageBlockButtons>
		      		<apex:pageBlockSection rendered="{!AND(OR(showReferenceabilityForContact,showReferenceabilityForAccount),referenceabilityPresent.size >0)}" title="{!$Label.Existing_Referenceability}" columns="1">
		      			 <apex:pageBlockTable value="{!referenceabilityPresent}" var="ref">
		      			 	<apex:column headerValue="Action">
		                        <apex:commandLink value="Del" onclick="deleteRef('{!ref.Id}');PORShowLoading();return false;"  >
		                        </apex:commandLink>
		                    </apex:column>
		                    <apex:column headerValue="{!$Label.Referenceability}">
		                        <apex:outputLabel value="{!ref.Referenceability_Type__r.Name}"></apex:outputLabel>
		                    </apex:column>
		      			 </apex:pageBlockTable>
		      		</apex:pageBlockSection>	
		      	</apex:pageBlock>
	      	</apex:outputPanel>
      	</apex:actionRegion>
        <apex:pageBlock id="pbId" title="{!$Label.Referencibility_Edit}" mode="edit">
            <apex:pageBlockButtons >
                <apex:outputPanel id="butonPanel">
                    <apex:commandButton value="{!$Label.Save}" onclick="showPopup(true); return false;" />
                    <apex:commandButton value="{!$Label.Cancel}" immediate="true" action="{!redirectToPage}"/>
                    <apex:commandButton value="{!$Label.Save_and_New}" onclick="showPopup(false); return false;"/>
                </apex:outputPanel>
            </apex:pageBlockButtons>
            
            <apex:pageBlockSection id="pbsId" columns="1" title="{!$Label.Information}">
                <apex:outputField value="{!refer.refedge__Account__c}" />
                <apex:pageBlockSectionItem id="pbsiId" rendered="{!(isContactsRendered)}">
                    <apex:outputLabel value="{!$Label.Contact}" />
                    <apex:selectList id="contactId" title="{!$Label.Contact}" onchange="PORShowLoading();findReferenceStatus(this.value);" size="1" value="{!refer.refedge__Contact__c}">
                           <apex:selectOptions value="{!contacts}"  id="selectContacts"></apex:selectOptions>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
                <apex:outputField rendered="{!NOT(isContactsRendered)}" value="{!refer.refedge__Contact__c}" />
                <apex:pageBlockSectionItem id="refType">
                    <apex:outputLabel value="{!$Label.Referenceability_Type}"/>
                        <apex:outputPanel styleClass="requiredInput" layout="block" >
                        <div class="requiredBlock"></div>
                        <c:POR_MultiSelectPicklist leftLabel="{!$Label.Available_Reference_Types}" leftSelOptions="{!referenceabilityTypes}" rightLabel="{!$Label.Selected_Reference_Types}" rightSelOptions="{!selectedFields}" size="20" width="200px">
                        </c:POR_MultiSelectPicklist>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:inputField required="true" value="{!refer.refedge__Status__c}" /> 
                <apex:inputField value="{!refer.refedge__Comment__c}" />
                <apex:inputField required="true" value="{!refer.refedge__Verified__c}"/>
            </apex:pageBlockSection>
        </apex:pageblock>
        <div id="dialogBoxDivCon" style="display:none;height: 60px; !important;">
            {!JSENCODE(status)}
        </div>
        <div id="dialogBoxDivAcc" style="display:none;height: 60px; !important;">
            <apex:outPutText value="{!JSENCODE(accStatus)}" escape="false"/>
        </div>
    </apex:form>
</apex:page>